<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>工業與服務業月薪與年薪視覺化</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 1000px;
        margin: auto;
        height: 100%;
        max-height: 1100px;
    }

    .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .controls .group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .controls label {
        margin-right: 10px;
    }

    .chart-container {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-top: 20px;
        width: 100%;
    }

    .chart {
        flex: 1;
        max-width: 50%; /* 限制每個圖表的最大寬度為50% */
        position: relative;
    }

    .chart-title {
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .bar {
        transition: all 0.3s ease;
    }

    .bar:hover {
        opacity: 0.8;
        cursor: pointer;
    }

    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        pointer-events: none;
        display: none;
    }

    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
        justify-content: center;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
    }

    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }

    #selected-info {
        margin-top: 20px;
        font-size: 16px;
        line-height: 1.6;
    }

    #selected-info .info-placeholder {
        color: gray;
        font-style: italic;
    }

    #selected-info strong {
        font-weight: bold;
    }


    .x-axis-label {
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        margin-top: 10px;
    }
</style>
</head>
<body>
<h1>各職業與各行業的月薪與年薪排名</h1>
<div class="controls">
    <div class="group">
        <h3>行業類別</h3>
        <label><input type="radio" name="industry" value="全部" checked> 全部</label>
        <label><input type="radio" name="industry" value="工業"> 工業</label>
        <label><input type="radio" name="industry" value="服務業"> 服務業</label>
    </div>
    <div class="group">
        <h3>職業類別</h3>
        <label><input type="radio" name="occupation" value="專業人員" checked> 專業人員</label>
        <label><input type="radio" name="occupation" value="主管及監督人員"> 主管及監督人員</label>
        <label><input type="radio" name="occupation" value="技術員及助理專業人員"> 技術員及助理專業人員</label>
        <label><input type="radio" name="occupation" value="事務支援人員"> 事務支援人員</label>
        <label><input type="radio" name="occupation" value="服務及銷售工作人員"> 服務及銷售工作人員</label>
        <label><input type="radio" name="occupation" value="技藝、機械設備操作及組裝人員"> 技藝、機械設備操作及組裝人員</label>
        <label><input type="radio" name="occupation" value="基層技術工及勞力工"> 基層技術工及勞力工</label>
    </div>
</div>
<div class="chart-container">
    <div id="chart-monthly" class="chart">
        <div class="chart-title">職業 v.s. 月薪</div>
    </div>
    <div id="chart-yearly" class="chart">
        <div class="chart-title">職業 v.s. 年薪</div>
    </div>
</div>
<div class="legend" id="legend"></div>
<div class="tooltip" id="tooltip"></div>
<div class="selected-info" id="selected-info"></div>

<script>

    const files = {
        工業月薪: "3_1.csv",
        工業年薪: "3_2.csv",
        服務業月薪: "3_3.csv",
        服務業年薪: "3_4.csv",
    };

    const chartWidth = 400; // 修改寬度以適應50%限制
    const chartHeight = 400;
    const margin = { top: 30, right: 20, bottom: 50, left: 100 };

    const tooltip = d3.select("#tooltip");

    let colorMap = new Map();
    let industryColorMap = { 工業: "#1f77b4", 服務業: "#ff7f0e" };
    let selectedIndustry = null;

    let selectedIndustryInfo = null;

    function loadData(industry, occupation) {
        if (industry === "全部") {
            Promise.all([
                d3.csv(files["工業月薪"]),
                d3.csv(files["服務業月薪"]),
                d3.csv(files["工業年薪"]),
                d3.csv(files["服務業年薪"]),
            ]).then(([industrialMonthly, serviceMonthly, industrialYearly, serviceYearly]) => {
                const combinedMonthly = combineData(parseData(industrialMonthly, "工業"), parseData(serviceMonthly, "服務業"));
                const combinedYearly = combineData(parseData(industrialYearly, "工業"), parseData(serviceYearly, "服務業"));

                updateLegend("全部");
                updateChart("#chart-monthly", combinedMonthly, occupation, "monthly", "全部");
                updateChart("#chart-yearly", combinedYearly, occupation, "yearly", "全部");
            });
        } else {
            Promise.all([
                d3.csv(files[`${industry}月薪`]),
                d3.csv(files[`${industry}年薪`]),
            ]).then(([monthlyData, yearlyData]) => {
                const monthlyParsed = parseData(monthlyData, industry);
                const yearlyParsed = parseData(yearlyData, industry);

                const allIndustries = [...new Set([...monthlyParsed.industries, ...yearlyParsed.industries])];
                colorMap = assignUniqueColors(allIndustries);

                updateLegend(allIndustries);
                updateChart("#chart-monthly", monthlyParsed, occupation, "monthly", industry);
                updateChart("#chart-yearly", yearlyParsed, occupation, "yearly", industry);
            });
        }
    }

    function combineData(data1, data2) {
        const industries = [...data1.industries, ...data2.industries];
        const occupations = data1.occupations;
        const values = data1.values.map((row, i) => row.concat(data2.values[i]));

        return { industries, occupations, values };
    }

    function parseData(data, industryType) {
        const industries = data.columns.slice(1).map(industry => `${industryType}-${industry}`);
        const occupations = data.map(d => d[data.columns[0]]);
        const values = data.map(row => industries.map((_, i) => +row[data.columns[i + 1]]));

        return { industries, occupations, values };
    }

    function assignUniqueColors(industries) {
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
        return new Map(industries.map((industry, index) => [industry, colorScale(index)]));
    }

     function updateLegend(items) {
        const legend = d3.select("#legend");
        legend.html("");

        if (items === "全部") {
            Object.entries(industryColorMap).forEach(([industry, color]) => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("span")
                    .attr("class", "legend-color")
                    .style("background-color", color);
                item.append("span").text(industry);
            });
        } else {
            items.forEach(industry => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("span")
                    .attr("class", "legend-color")
                    .style("background-color", colorMap.get(industry));
                // 直接移除「工業-」「服務業-」
                const industryName = industry.replace(/^(工業|服務業)-/, "");
                item.append("span").text(industryName);
            });
        }
    }

    function updateChart(chartId, data, occupation, type, industry) {
        const chart = d3.select(chartId);
        chart.select("svg").remove();

        const svg = chart
            .append("svg")
            .attr("width", chartWidth + margin.left + margin.right)
            .attr("height", chartHeight + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const occupationIndex = data.occupations.indexOf(occupation);
        const displayedData = data.industries.map((industry, i) => ({
            industry,
            value: data.values[occupationIndex][i],
        }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 10);

        const x = d3
            .scaleLinear()
            .domain([0, d3.max(displayedData, d => d.value)])
            .range([0, chartWidth]);

        const y = d3
            .scaleBand()
            .domain(displayedData.map(d => d.industry.replace(/^(工業|服務業)-/, ""))) // 移除前綴
            .range([0, chartHeight])
            .padding(0.1);

        svg.append("text")
            .attr("class", "x-axis-label")
            .attr("x", chartWidth / 2) // 水平置中
            .attr("y", chartHeight + margin.bottom - 10) // 放在 X 軸的下方
            .attr("text-anchor", "middle") // 文字置中
            .text(type === "monthly" ? "月薪（元）" : "年薪（萬元）");

        svg
            .selectAll(".bar")
            .data(displayedData)
            .join("rect")
            .attr("class", "bar")
            .attr("x", 0)
            .attr("y", d => y(d.industry.replace(/^(工業|服務業)-/, ""))) // 移除前綴
            .attr("height", y.bandwidth())
            .attr("fill", d => {
                if (industry === "全部") {
                    return d.industry.startsWith("工業") ? industryColorMap["工業"] : industryColorMap["服務業"];
                }
                return colorMap.get(d.industry);
            })
            .on("click", (event, d) => {
                toggleHighlight(d.industry);
                toggleIndustryInfo(d, occupation, type);
            })
            .on("mouseover", (event, d) => showTooltip(event, d.industry, d.value, type))
            .on("mousemove", event => moveTooltip(event))
            .on("mouseout", () => hideTooltip())
            .transition()
            .duration(1000)
            .attr("width", d => x(d.value));

        svg.append("g").call(d3.axisLeft(y));
        svg.append("g").attr("transform", `translate(0,${chartHeight})`).call(d3.axisBottom(x));
    }

    function toggleHighlight(industry) {
        if (selectedIndustry === industry) {
            selectedIndustry = null;
            d3.selectAll(".bar").transition().duration(300).attr("opacity", 1);
        } else {
            selectedIndustry = industry;
            d3.selectAll(".bar")
                .transition()
                .duration(300)
                .attr("opacity", d => d.industry === industry ? 1 : 0.3);
        }
    }

    function toggleIndustryInfo(d, occupation, type) {
        const infoContainer = d3.select("#selected-info");

        if (selectedIndustryInfo === d.industry) {
            selectedIndustryInfo = null;
            infoContainer.html('<span class="info-placeholder">點擊長條圖內容，顯示詳細資訊。</span>');
        } else {
            selectedIndustryInfo = d.industry;
            infoContainer.html(`
                <div><strong>職業名稱：</strong>${d.industry.replace(/^(工業|服務業)-/, "")}</div>
                <div><strong>${type === "monthly" ? "月薪：" : "年薪："}</strong>${d.value} ${type === "monthly" ? "元" : "萬元"}</div>
            `);
        }
    }

    function showTooltip(event, industry, value, type) {
        tooltip.style("display", "block")
            .html(
                `<strong>職業名稱:</strong> ${industry}<br>
                 <strong>${type === "monthly" ? "月薪" : "年薪"}:</strong> ${value} ${type === "monthly" ? "元" : "萬元"}`
            );
    }

    function moveTooltip(event) {
        tooltip.style("top", `${event.pageY + 10}px`)
            .style("left", `${event.pageX + 10}px`);
    }

    function hideTooltip() {
        tooltip.style("display", "none");
    }

    d3.selectAll("input[name='industry']").on("change", function () {
        const industry = d3.select("input[name='industry']:checked").node().value;
        const occupation = d3.select("input[name='occupation']:checked").node().value;
        loadData(industry, occupation);
    });

    d3.selectAll("input[name='occupation']").on("change", function () {
        const industry = d3.select("input[name='industry']:checked").node().value;
        const occupation = d3.select("input[name='occupation']:checked").node().value;
        loadData(industry, occupation);
    });

    loadData("全部", "專業人員");
</script>
</body>
</html>