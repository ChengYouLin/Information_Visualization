<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>薪資與人數 Treemap</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;

      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-top: 20px;
      font-size: 28px;
      color: #444;
      text-align: center;
    }

    #controls {
      margin: 20px 0;
    }

    #controls label {
      font-size: 16px;
      margin-right: 10px;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      height: auto;
      max-height: 1100px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .treemap {
      width: 100%;
      max-width: 800px;
      height: 600px;
      margin: 20px auto;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: linear-gradient(135deg, #ffffff, #e8eaf6);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      pointer-events: none;
      font-size: 14px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    text {
      font-size: 12px;
      fill: #fff;
      pointer-events: none;
    }

    .highlighted {
      stroke: #ff5722;
      stroke-width: 3px;
    }

    #legend {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-right: 15px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 5px;
      border-radius: 3px;
    }

    #details {
      margin-top: 10px;
      font-size: 16px;
      color: #333;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>各職業月薪與年薪前十名與受僱人數關係（Treemap）</h1>
  <div id="controls">
    <label><input type="radio" name="salaryType" value="monthly" checked> 月薪（元）</label>
    <label><input type="radio" name="salaryType" value="annual"> 年薪（萬元）</label>
  </div>
  <div class="container">
    <div id="legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: #743A3A;"></div>
        <span>第一名</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #984B4B;"></div>
        <span>第二名</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #B87070;"></div>
        <span>第三名</span>
      </div>
    </div>
    <div class="treemap" id="treemap"></div>
    <div class="tooltip" id="tooltip"></div>
    <div id="details">點擊一個區塊以查看詳細資訊</div>
  </div>

  <script>
    const files = {
      monthly: "1.csv",
      annual: "2.csv",
      employment: "4_1.csv"
    };

    const treemapWidth = 800;
    const treemapHeight = 600;
    const svg = d3.select("#treemap")
      .append("svg")
      .attr("width", treemapWidth)
      .attr("height", treemapHeight);

    const tooltip = d3.select("#tooltip");
    const details = d3.select("#details");

    const parseData = (salaryData, employmentData) => {
      const industries = Object.keys(salaryData[0]).slice(1);
      const jobs = employmentData.map(d => d[Object.keys(d)[0]]);

      const structuredData = [];
      for (let i = 0; i < jobs.length; i++) {
        for (let j = 0; j < industries.length; j++) {
          structuredData.push({
            細項: jobs[i],
            行業: industries[j],
            薪資: +salaryData[i][industries[j]] || 0,
            人數: +employmentData[i][industries[j]] || 0
          });
        }
      }
      return structuredData;
    };

    let highlighted = null;

    const loadAndDrawTreemap = (salaryType) => {
      Promise.all([
        d3.csv(files[salaryType]),
        d3.csv(files.employment)
      ]).then(([salaryData, employmentData]) => {
        const combinedData = parseData(salaryData, employmentData);
        const top10 = combinedData.sort((a, b) => b.薪資 - a.薪資).slice(0, 10);

        const colorTop3 = ["#743A3A", "#984B4B", "#B87070"];
        const colorOthers = "#CF9E9E";

        const root = d3.hierarchy({ children: top10 })
          .sum(d => d.薪資);

        d3.treemap()
          .size([treemapWidth, treemapHeight])
          .padding(4)(root);

        svg.selectAll("*").remove();

        const nodes = svg.selectAll("g")
          .data(root.leaves())
          .enter()
          .append("g")
          .attr("transform", d => `translate(${d.x0},${d.y0})`);

        nodes.append("rect")
          .attr("width", d => d.x1 - d.x0)
          .attr("height", d => d.y1 - d.y0)
          .attr("fill", (d, i) => i < 3 ? colorTop3[i] : colorOthers)
          .attr("stroke", "#fff")
          .attr("stroke-width", 1)
          .style("cursor", "pointer")
          .on("mouseover", (e, d) => {
            const unit = salaryType === "monthly" ? "元" : "萬元";
            tooltip.transition().duration(200).style("opacity", 1);
            tooltip.html(`<strong>${d.data.細項}</strong><br>薪資: ${d.data.薪資} ${unit}<br>人數: ${d.data.人數}`)
              .style("left", `${e.pageX + 10}px`)
              .style("top", `${e.pageY + 10}px`);
          })
          .on("mousemove", (e) => {
            tooltip.style("left", `${e.pageX + 10}px`)
              .style("top", `${e.pageY + 10}px`);
          })
          .on("mouseout", () => {
            tooltip.transition().duration(200).style("opacity", 0);
          })
          .on("click", function (e, d) {
            const unit = salaryType === "monthly" ? "元" : "萬元";
            if (highlighted === d) {
              svg.selectAll("rect")
                .transition()
                .duration(500)
                .style("opacity", 1);
              highlighted = null;
              details.text("點擊一個區塊以查看詳細資訊");
            } else {
              svg.selectAll("rect")
                .transition()
                .duration(500)
                .style("opacity", 0.3);
              d3.select(this)
                .transition()
                .duration(500)
                .style("opacity", 1);
              highlighted = d;

              details.html(`
                <strong>職業名稱:</strong> ${d.data.細項}<br>
                <strong>薪資:</strong> ${d.data.薪資} ${unit}<br>
                <strong>人數:</strong> ${d.data.人數}人
              `);
            }
          });
          nodes.each(function (d) {
        const g = d3.select(this);
        const personCount = Math.max(1, Math.round(d.data.人數 / 1000)); // 每1000人一個小人，最少1個
        for (let i = 0; i < personCount; i++) {
        const x = (i % Math.floor((d.x1 - d.x0) / 20)) * 20;
        const y = Math.floor(i / Math.floor((d.x1 - d.x0) / 20)) * 40 + 30;
        if (y + 40 < d.y1 - d.y0) {
          g.append("circle") // 頭部
          .attr("cx", x + 10)
          .attr("cy", y + 10)
          .attr("r", 5)
          .attr("fill", "#ffcc00");
          g.append("line") // 身體
          .attr("x1", x + 10)
          .attr("y1", y + 15)
          .attr("x2", x + 10)
          .attr("y2", y + 30)
          .attr("stroke", "#ffcc00");
          g.append("line") // 手臂
          .attr("x1", x + 5)
          .attr("y1", y + 20)
          .attr("x2", x + 15)
          .attr("y2", y + 20)
          .attr("stroke", "#ffcc00");
          g.append("line") // 左腿
          .attr("x1", x + 10)
          .attr("y1", y + 30)
          .attr("x2", x + 5)
          .attr("y2", y + 35)
          .attr("stroke", "#ffcc00");
          g.append("line") // 右腿
          .attr("x1", x + 10)
          .attr("y1", y + 30)
          .attr("x2", x + 15)
          .attr("y2", y + 35)
          .attr("stroke", "#ffcc00");
          }
          }
        });

        nodes.append("text")
          .attr("x", 5)
          .attr("y", 20)
          .text(d => d.data.細項)
          .attr("fill", "white")
          .attr("font-size", "12px");
      });
    };

    loadAndDrawTreemap("monthly");

    d3.selectAll("input[name='salaryType']").on("change", function () {
      loadAndDrawTreemap(this.value);
    });
  </script>
</body>
</html>